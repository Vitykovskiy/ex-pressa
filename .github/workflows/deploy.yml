name: Deploy backend

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -euo pipefail

            # 1) update code
            cd ~/deploy/back
            git fetch origin
            git checkout deploy
            git reset --hard origin/deploy

            # 2) write .env (defaults + secrets)
            cat > ~/deploy/back/.env <<'EOF'
            DB_HOST=postgres
            EOF

            cat >> ~/deploy/back/.env <<EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            AUTH_JWT_SECRET=${{ secrets.AUTH_JWT_SECRET }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            PORT=${{ secrets.PORT }}
            WEB_APP_URL=${{ secrets.WEB_APP_URL }}
            EOF

            chmod 600 ~/deploy/back/.env

            # 3) deploy (build happens inside Docker)
            cd ~/deploy/back
            docker compose -f docker-compose.prod.yaml up -d --build
